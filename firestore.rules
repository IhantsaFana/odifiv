rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isAdmin(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.role == 'admin';
    }

    function isValidator(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.role in ['admin', 'validator'];
    }

    // ==================== USERS COLLECTION ====================
    // Stores user profile information
    match /users/{userId} {
      // Read: Users can read their own document + admin can read all
      allow read: if isAuthenticated() && (isOwner(userId) || isAdmin(request.auth.uid));
      
      // Create: New users can create their own profile during registration
      allow create: if isAuthenticated() && isOwner(userId) && 
        request.resource.data.keys().hasOnly(['email', 'displayName', 'photoURL', 'role', 'createdAt', 'division', 'position']) &&
        request.resource.data.email is string &&
        request.resource.data.displayName is string &&
        request.resource.data.role == 'member' &&
        request.resource.data.createdAt == request.time;
      
      // Update: Users can update their own profile
      allow update: if isAuthenticated() && (
        isOwner(userId) || 
        isAdmin(request.auth.uid)
      ) &&
        request.resource.data.keys().hasOnly(['email', 'displayName', 'photoURL', 'role', 'createdAt', 'division', 'position', 'updatedAt']) &&
        request.resource.data.email is string &&
        request.resource.data.displayName is string &&
        request.resource.data.updatedAt == request.time &&
        (isOwner(userId) ? request.resource.data.role == resource.data.role : true);
      
      // Delete: Only admins can delete user accounts
      allow delete: if isAuthenticated() && isAdmin(request.auth.uid);

      // ==================== MEMBERS SUB-COLLECTION ====================
      // Stores scout member information linked to user
      match /members/{memberId} {
        allow read: if isAuthenticated() && (
          isOwner(userId) || 
          isAdmin(request.auth.uid)
        );
        
        allow create: if isAuthenticated() && isOwner(userId) &&
          request.resource.data.keys().hasOnly([
            'firstName', 'lastName', 'totem', 'division', 
            'currentSampana', 'position', 'talents', 'phone',
            'createdAt', 'updatedAt'
          ]) &&
          request.resource.data.firstName is string &&
          request.resource.data.lastName is string &&
          request.resource.data.division in ['voronkely', 'mpanazova', 'afo', 'menafify'];
        
        allow update: if isAuthenticated() && isOwner(userId) &&
          request.resource.data.updatedAt == request.time;
        
        allow delete: if isAuthenticated() && (
          isOwner(userId) || 
          isAdmin(request.auth.uid)
        );
      }

      // ==================== ACTIVITIES SUB-COLLECTION ====================
      // Stores user activities and offline sync data
      match /activities/{activityId} {
        allow read: if isAuthenticated() && (
          isOwner(userId) || 
          isAdmin(request.auth.uid)
        );
        
        allow create: if isAuthenticated() && isOwner(userId) &&
          request.resource.data.keys().hasAll(['type', 'timestamp', 'data']) &&
          request.resource.data.type is string &&
          request.resource.data.timestamp == request.time;
        
        allow update: if isAuthenticated() && isOwner(userId) &&
          request.resource.data.timestamp == resource.data.timestamp;
        
        allow delete: if isAuthenticated() && isOwner(userId);
      }
    }

    // ==================== FIVONDRONANA COLLECTION ====================
    // Stores Scout administrative structure (geographic zones)
    match /fivondronana/{fivondronanaId} {
      // Authenticated users can read all fivondronana structures
      allow read: if isAuthenticated();
      
      // Only admins can create/update/delete
      allow create: if isAuthenticated() && isAdmin(request.auth.uid) &&
        request.resource.data.keys().hasOnly(['name', 'number', 'faritra', 'faritany', 'foibe', 'createdAt']) &&
        request.resource.data.name is string &&
        request.resource.data.number is int;
      
      allow update: if isAuthenticated() && isAdmin(request.auth.uid) &&
        request.resource.data.updatedAt == request.time;
      
      allow delete: if isAuthenticated() && isAdmin(request.auth.uid);

      // ==================== SAMPANA SUB-COLLECTION ====================
      // Stores sampana/group structure within fivondronana
      match /sampana/{sampanaId} {
        allow read: if isAuthenticated();
        
        allow create: if isAuthenticated() && isValidator(request.auth.uid) &&
          request.resource.data.keys().hasOnly(['name', 'type', 'members', 'createdAt']) &&
          request.resource.data.name is string &&
          request.resource.data.type is string;
        
        allow update: if isAuthenticated() && isValidator(request.auth.uid) &&
          request.resource.data.updatedAt == request.time;
        
        allow delete: if isAuthenticated() && isAdmin(request.auth.uid);
      }

      // ==================== EVENTS SUB-COLLECTION ====================
      // Stores fivondronana events
      match /events/{eventId} {
        allow read: if isAuthenticated();
        
        allow create: if isAuthenticated() && isValidator(request.auth.uid) &&
          request.resource.data.keys().hasOnly(['title', 'description', 'date', 'location', 'createdAt']) &&
          request.resource.data.title is string &&
          request.resource.data.date is timestamp;
        
        allow update: if isAuthenticated() && (
          isValidator(request.auth.uid) || 
          isAdmin(request.auth.uid)
        ) &&
          request.resource.data.updatedAt == request.time;
        
        allow delete: if isAuthenticated() && isAdmin(request.auth.uid);
      }
    }

    // ==================== OFFLINE_SYNC COLLECTION ====================
    // Stores pending offline changes for sync when online
    match /offline_sync/{userId}/{syncId} {
      allow read: if isAuthenticated() && isOwner(userId);
      
      allow create: if isAuthenticated() && isOwner(userId) &&
        request.resource.data.keys().hasAll(['operation', 'collection', 'data', 'timestamp']) &&
        request.resource.data.operation in ['create', 'update', 'delete'];
      
      allow update: if isAuthenticated() && isOwner(userId);
      
      allow delete: if isAuthenticated() && (
        isOwner(userId) || 
        isAdmin(request.auth.uid)
      );
    }

    // ==================== AUDIT_LOG COLLECTION ====================
    // Stores audit logs for admin operations
    match /audit_log/{logId} {
      // Only authenticated users and admins can read
      allow read: if isAuthenticated() && isValidator(request.auth.uid);
      
      // System can write (via Cloud Functions), users can't directly write
      allow create: if false;
      allow update: if false;
      allow delete: if isAuthenticated() && isAdmin(request.auth.uid);
    }

    // ==================== DEFAULT: DENY ALL ====================
    // Catch-all: deny all access to undefined collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
